---
- name: Install AWS CodeDeploy Agent on Rocky Linux 9
  hosts: localhost
  gather_facts: no
  become: true
  become_user: root
  become_method: sudo
  tasks:
    - name: Update all packages
      dnf:
        name: '*'
        state: latest

    - name: Install Ruby
      dnf:
        name: ruby
        state: present

    - name: Install wget
      dnf:
        name: wget
        state: present

    - name: Download CodeDeploy install script
      get_url:
        url: https://aws-codedeploy-us-east-2.s3.us-east-2.amazonaws.com/latest/install
        dest: /tmp/install
        mode: 'u+x'

    - name: Run CodeDeploy install script
      command: /tmp/install auto

    - name: Start and enable CodeDeploy Agent service
      systemd:
        name: codedeploy-agent
        state: started
        enabled: true
        daemon_reload: yes  # Ensures that the service is reloaded after installation

    - name: Check CodeDeploy Agent status
      systemd:
        name: codedeploy-agent
        state: started
